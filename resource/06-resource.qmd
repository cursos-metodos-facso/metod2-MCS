---
title: "Pr√°ctica 6 Regresi√≥n log√≠stica y Probabilidades predichas"
subtitle: "Metodolog√≠a I - Mag√≠ster en Ciencias Sociales"
linktitle: "Pr√°ctica 6: Regresi√≥n log√≠stica y Probabilidades predichas"
date: "2023-06-23"
lang: es
---

# Presentaci√≥n

La Encuesta Mundial de Valores (EMV) o World Values Survey [WVS](https://www.worldvaluessurvey.org/wvs.jsp) es un proyecto global de investigaci√≥n social que explora los valores y opiniones de la gente, c√≥mo estos cambian con el tiempo, y su impacto social y pol√≠tico. Desde 1981 una red mundial de cient√≠ficos sociales y polit√≥logos llevan a cabo esta investigaci√≥n, haciendo encuestas nacionales representativas en casi 100 pa√≠ses. La WVS es la √∫nica fuente de datos emp√≠ricos sobre actitudes y valores humanos que abarca a la mayor√≠a de la poblaci√≥n mundial (casi el 90%).

## Objetivo

En el ejemplo de esta pr√°ctica, que utiliza solo casos para Chile entre 2005 y 2022, se intentar√° responder la pregunta ¬øexiste una relaci√≥n entre la afiliaci√≥n a sindicatos y la participaci√≥n en marchas?

Debido a la naturaleza de la variable dependiente participaci√≥n en marchas (si/no), el objetivo de esta pr√°ctica es estimar modelos de regresi√≥n log√≠stica binaria.

# Librer√≠as

```{r}
pacman::p_load(tidyr,
               dplyr,
               sjPlot,
               sjmisc,
               psych,
               texreg,
               haven,
               ggplot2,
               lmtest,
               DescTools)
```

# Datos

```{r}
WVS_2005_2022_Chl<- readRDS(file = "../files/data/WVS_2005_2022_Chl.rds")
```

```{r eval=FALSE}
#Cargamos la base de datos desde internet
load(url("https://github.com/Kevin-carrasco/metod1-MCS/raw/main/files/data/WVS_2005_2022_Chl.RData"))
```

## Explorar datos

```{r}
summary(WVS_2005_2022_Chl) #con comando de paquete haven
describe(WVS_2005_2022_Chl) #con comando de paquete psych
```

# Regresiones log√≠sticas

El punto de partida es transformaci√≥n de los coeficientes ùõΩ en coeficientes logit:

* Se conoce como ‚Äúlogit‚Äù a la transformaci√≥n logar√≠tmica de los odds (traducidos com√∫nmente como ‚Äúchances‚Äù)

* ¬øQu√© son los odds? Una raz√≥n de probabilidades

* Por lo tanto, para estimar probabilidades a trav√©s de una regresi√≥n log√≠stica hay que seguir estos pasos:
  1. Estimar los odds o raz√≥n de probabilidades
  2. Estimar odds ratios (razones entre odds)
  3. Aplicar una transformaci√≥n logar√≠tmica a esos odds ratios para obtener coeficientes logit
  4. Calcular las probabilidades

## Tabla de contingencia bivariado: sindicalizaci√≥n / participaci√≥n en marchas

```{r}
WVS_2005_2022_Chl <- WVS_2005_2022_Chl %>%
  mutate(Unionized = labelled(.$Unionized,c("No"=0,"S√≠"=1)),
         demonstr_dummy = labelled(.$demonstr_dummy,c("No"=0,"S√≠"=1)))

WVS_2005_2022_Chl <- as.data.frame(WVS_2005_2022_Chl) #para que la base quede como data frame (necesario para las figuras)

frq(WVS_2005_2022_Chl$Unionized)
frq(WVS_2005_2022_Chl$demonstr_dummy)

sjPlot::tab_xtab(var.col = WVS_2005_2022_Chl$Unionized, 
                 var.row = WVS_2005_2022_Chl$demonstr_dummy, 
                 title = "Participaci√≥n en marchas seg√∫n afiliaci√≥n sindical", 
                 show.col.prc = TRUE,
                 value.labels = TRUE,
                 encoding = "UTF-8")
```

### Odds

$$Odds_{participar} = \frac{0.207}{0.793} = 0.26$$

Las chances de participar en una marcha son de 0,26, respecto a las chances de no participar

* En otras palabras: por cada 1 persona, hay s√≥lo 0,26 personas que participan en marchas.

* O m√°s intuitivamente, por cada 100 personas, hay s√≥lo 26 personas que participan

¬øCambian las chances de participar seg√∫n se est√© afiliado/a a un sindicato

$$Odds_{sindical} = \frac{0.26}{0.74} = 0.35$$

$$Odds_{no.sindical} = \frac{0.194}{0.806} = 0.24$$

¬øC√≥mo se interpretan los odds?

* Valores bajo 1 indican que las chances de que ocurra un evento son negativas

* Valores iguales a 1 indican chances iguales

* Valores sobre 1 indican chances positivas

### Odds ratios (razones de chances)

* C√°lculo que permite reflejar asociaci√≥n entre dos variables dicot√≥micas, a partir de una comparaci√≥n entre chances

* Siguiendo con el ejemplo anterior, ¬øtienen los/as sindicalizados m√°s chances de participar en marchas que quienes no est√°n sindicalizados/as?

$$OR = \frac{P_{sindical}/(1-P_{sindical})}{P_{no.sindical}/(1-P_{no.sindical})}$$

$$OR = \frac{0.26/0.74}{0.194/0.806} = \frac{0.35}{0.24} = 1.46$$

Las chances de participar en marchas de los/as sindicalizados/as son 1,5 veces m√°s que las de quienes no est√°n sindicalizados/as

* Implicancias:

  1. El odds ratio o razones de chances es √∫til porque nos permite expresar en un n√∫mero la relaci√≥n entre dos variables categ√≥ricas
  2. En las regresiones log√≠sticas, el odds ratio es la primera manera de aproximarnos a relaci√≥n entre variables
  3. Sin embargo, falta un paso m√°s necesario para construir modelos de regresi√≥n log√≠stica
  
## Logit

* Es una unidad de medida de la relaci√≥n entre dos variables (VD: dicot√≥mica), que en regresi√≥n log√≠stica se calcula a partir del logaritmo natural de los odds

* Esta transformaci√≥n logar√≠tmica es la base de la estimaci√≥n de par√°metros en la regresi√≥n log√≠stica:

La mejor combinaci√≥n lineal de predictores no se obtiene a trav√©s de MCO, sino a trav√©s del procedimiento de m√°xima verosimilitud

* A diferencia de los odds ratio, los coeficientes logit tienen valores que van de ‚Äì\infty a +\infty

## Modelo de probabilidad lineal

Primero, solo para comparaci√≥n, estimamos un modelo de probabilidad lineal.

```{r}
m1mpl <- lm(demonstr_dummy ~ Unionized + Wave, data = WVS_2005_2022_Chl)
```


```{r results='asis'}
htmlreg(m1mpl,
          custom.model.names = "Modelo de Prob Lineal",
          digits = 3, 
          stars = c(0.001, 0.01, 0.05, 0.1),symbol = "‚Ä†")
```

## Modelo de regresi√≥n log√≠stica

```{r}
m0log <- glm(demonstr_dummy~ Unionized, data = WVS_2005_2022_Chl, family = "binomial"(link = "logit"))
m1log <- glm(demonstr_dummy~ Unionized + Wave, data = WVS_2005_2022_Chl, family = "binomial"(link = "logit"))
#nota: "logit" viene por defecto en la opci√≥n "binomial", por eso no es necesario 
#incluirla expl√≠citamente en el c√≥digo (tal como lo hago en los modelos sgtes)
m2log <- glm(demonstr_dummy~ Unionized + Female + X003 + Educ + private_sector + Wave, data = WVS_2005_2022_Chl,family = "binomial")
m3log <- glm(demonstr_dummy~ Unionized + Female + X003 + Educ + private_sector + politicization + Wave, data = WVS_2005_2022_Chl,family = "binomial")
```


```{r results='asis'}
htmlreg(list(m1mpl, m1log,m2log,m3log),
          custom.model.names = c("M1 (m prob lineal)","M1 (log odds)","M2 (log odds)","M3 (log odds)"),
          digits = 3, 
          stars = c(0.001, 0.01, 0.05, 0.1),symbol = "‚Ä†")
```

En el Modelo 1 (M1), el log-odds de participaci√≥n en marchas para afiliados a sindicatos aumenta en 0.418 en comparaci√≥n con los no sindicalizados (p<0.01). Este resultado mantiene su significaci√≥n estad√≠stica en el Modelo 2 y baja su significaci√≥n a p<0.1 en el Modelo 3, al controlar por las dem√°s variables independientes.

En el Modelo 2, En comparaci√≥n a los/as trabajadores/as del sector p√∫blico (categor√≠a de referencia), el log-odds de participaci√≥n en marchas para los/as del sector privado disminuye en 0,52 (p < 0,01), manteniendo el resto de variables constantes.

En el Modelo 3, por cada unidad de aumento en la escala de politizaci√≥n, el log-odds de participaci√≥n en marchas aumenta en 0,28 (p < 0,001), manteniendo el resto de las variables constantes.

### Problemas de interpretaci√≥n 

A pesar de sus ventajas, los coeficientes logit son dif√≠ciles de interpretar:

* Los coef. logit son el resultado de una transformaci√≥n de la escala original

* Ellos no muestran directamente probabilidades

* Entonces: Volver a la escala original de **odds ratio** mediante la **exponenciaci√≥n de los coeficientes** (la funci√≥n exponencial es la inversa del logaritmo)

$$logit_x = log(odds)$$

$$e^{logit} = odds_x$$

$$e^{0.39} = odds_x = 1.477$$

Las chances (odds) de participar en marchas de los/as sindicalizados/as son 1,5 veces m√°s que las de quienes no est√°n sindicalizados/as, controlando por las otras variables incluidas en el modelo

## Estimaci√≥n de odds ratios

```{r}
exp(coef(m1log)) #comando b√°sico

### C√°lculo de OR para cada modelo
m0log_OR <- exp(coef(m0log))
m1log_OR <- exp(coef(m1log))
m2log_OR <- exp(coef(m2log))
m3log_OR <- exp(coef(m3log))
```


```{r results='asis'}
##Odds ratios en tabla de texreg
htmlreg(list(m1log,m2log,m3log), 
          override.coef = list(m1log_OR,m2log_OR,m3log_OR), # Sobreescribir coeficientes
          custom.model.names = c("m1 (OR)","m2 (OR)","m3 (OR)"),
          digits = 3, 
          stars = c(0.001, 0.01, 0.05, 0.1),symbol = "‚Ä†")
#Nota: errores est√°ndares en esta tabla NO tienen  sentido (no est√°n calculados a partir de OR, sino de log odds)
#Es mejor no reportarlos si solo se van a presentar odds ratios
```

Sin embargo, los coeficientes de un modelo de reg. log√≠stica (log-odds u odds-ratios) no son comparables con los coeficientes de otro modelo

## C√°lculo de probabilidades predichas

```{r results='asis'}
# Tabla b√°sica: s√≥lo sindicalizacion como vble independ
htmlreg(m0log,
          custom.model.names = c("m0 (log odds)"),
          digits = 3, 
          stars = c(0.001, 0.01, 0.05, 0.1),symbol = "‚Ä†")
```

A partir de este modelo se pueden predecir log-odds y, m√°s importante a√∫n, probabilidades para personas con distintos atributos controlados en el modelo (ej., sindicalizadas o no)

$$logit(prob.marcha) = ùõº+ ùõΩ_1X_1 $$

$$logit(prob.marcha)_{sindical} = -1.422 + (0.374 * Unionized=1) = -1.048 $$

$$logit(prob.marcha)_{no.sindical} = -1.422 + (0.374 * Unionized=0) = -1.422 $$

Este ‚Äúpuntaje predicho‚Äù (log-odds) no tiene interpretaci√≥n, por lo que hay que pasarlo a Odds


$$Odds_x = e^{ùõº+ùõΩ_jX_j}$$

$$Odds_{sindicalizados} = e^{-1.048} = 0.35$$

$$Odds_{no.sindicalizados} = e^{-1.422} = 0.24$$

Finalmente, habiendo calculado los odds para cada tipo de persona se pueden calcular sus probabilidades predichas

$$p = \frac{e^{ùõº+ùõΩ_jX_j}}{1+e^{ùõº+ùõΩ_jX_j}} = \frac{odds_{xj}}{1+odds_{xj}}$$

$$p_{sindicalizados} = \frac{0.35}{1+0.35} = \frac{0.35}{1.35} = 0.26$$

$$p_{no.sindicalizados} = \frac{0.24}{1+0.24} = \frac{0.24}{1.24} = 0.19$$

La probabilidad de que un/a sindicalizado participe en marchas es del 26%, mientras que la probabilidad de que alguien que no est√© sindicalizado/a es del 19%


## C√°lculo de probabilidades predichas en R

* Paquete ggeffects de R: √∫ltil para estimar probabilidades predichas a partir de modelos de regresi√≥n log√≠sticas

* Combinado con ggplot2, se pueden generar gr√°ficos que muestran de modo m√°s intuitivo la relaci√≥n entre variables

Gr√°fico de probabilidades predichas para sindicalizados/as y no sindicalizados/as

```{r}
FigSind_1_Prob <- ggeffects::ggpredict(m3log, terms = c("Unionized")) %>%
  ggplot(aes(x=x, y=predicted)) +
  geom_bar(stat="identity", color="grey", fill="grey")+
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width=.1) +
  labs(title="Sindicalizaci√≥n", x = "", y = "") +
  theme_bw() +
  theme(plot.title = element_text(size = 12), 
        axis.text.x = element_text(angle = 0, vjust = 0.5, size = 12),
        axis.text.y = element_text(vjust = 0.5, size = 10)) +
  scale_x_continuous(name = "",
                     breaks = c(0,1),
                     labels = c("Non-union members", "Union members")) +
  scale_y_continuous(limits = c(0,0.35), 
                     breaks = seq(0,0.35, by = 0.05),
                     labels = scales::percent_format(accuracy = 1L))

FigSind_1_Prob
```

Gr√°fico de probabilidades predichas para variable politizaci√≥n

```{r}
FigPolit_1_Prob<- ggeffects::ggpredict(m3log, terms="politicization") %>%
  ggplot(mapping=aes(x = x, y=predicted)) +
  labs(title="Politizaci√≥n", x = "", y = "")+
  theme_bw() +
  geom_smooth()+
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .2, fill = "black") +
  theme(plot.title = element_text(size = 12), 
        axis.text.x = element_text(angle = 0, vjust = 0.5, size = 10),
        axis.text.y = element_text(vjust = 0.5, size = 10))+
  scale_x_continuous(breaks = seq(0,6, by = 1))+
  scale_y_continuous(limits = c(0,0.6), breaks=seq(0,0.6, by = 0.1),
                     labels = scales::percent_format(accuracy = 1L))

FigPolit_1_Prob
```

## Bondad de ajuste (comando de paquete lmtest)

* Raz√≥n de verosimilitudes

```{r}
anova(m1log, m2log, test = "Chisq")
anova(m2log, m3log, test = "Chisq") 
lrtest(m1log, m2log) #likelihood ratio test / Prueba de raz√≥n de verosimilitud (comparaci√≥n m1-m2)

lrtest(m2log, m3log) #likelihood ratio test / Prueba de raz√≥n de verosimilitud (comparaci√≥n m2-m3)
```

* Pseudo R2 (McFadden)

```{r}
m1log_R2<-DescTools::PseudoR2(m1log)
m2log_R2<-DescTools::PseudoR2(m2log)
m3log_R2<-DescTools::PseudoR2(m3log)
```


```{r results='asis'}
#Misma tabla, en log odds, con Pseudo R2
htmlreg(list(m1log,m2log,m3log),
          custom.model.names = c("m1 (log odds)","m2 (log odds)","m3 (log odds)"),
          custom.gof.rows=list("Pseudo R2" = c(m1log_R2, m2log_R2,m3log_R2)),
          digits = 3, 
          stars = c(0.001, 0.01, 0.05, 0.1),symbol = "‚Ä†")
```

## Efectos de interacci√≥n

sindicalizacion - sector privado

```{r}
m3.1log <- glm(demonstr_dummy~ Unionized + Female + X003 + Educ + private_sector + politicization + Wave + Unionized*private_sector, 
               data = WVS_2005_2022_Chl,family = "binomial")
```


```{r results='asis'}
htmlreg(list(m1log,m2log,m3log,m3.1log),
          custom.model.names = c("M1 (log odds)","M2 (log odds)","M3 (log odds)",
                                 "M3.1 (log odds)"),
          digits = 3, 
          stars = c(0.001, 0.01, 0.05, 0.1),symbol = "‚Ä†")
```

* La interacci√≥n tambi√©n se puede graficar seg√∫n probabilidades predichas

```{r}
# ojo que la relaci√≥n sindicalizaci√≥n x sector privado no es significativa
FigSindSector_int<-ggeffects::ggpredict(m3.1log, terms = c("Unionized", "private_sector")) %>%
  ggplot(aes(x=x, y=predicted, shape = group, color = group)) +
  geom_line(aes(group=group,linetype = group),position = position_dodge(.1)) + 
  geom_point(size = 2.5,position = position_dodge(.1))+
  scale_x_continuous(name = "", breaks=c(0,1), labels = c("No sindicalizados/as", "Sindicalizados/as")) + 
  scale_shape_discrete(name = "Sector de empleo",
                       limits = c("0", "1"),
                       labels = c("P√∫blico", "Privado")) +
  scale_color_manual(name = "Sector de empleo",
                     limits = c("0", "1"),
                     labels = c("P√∫blico", "Privado"),
                     values = c("black", "black")) +
  scale_linetype_manual(name = "Sector de empleo",
                        limits = c("0", "1"),
                        labels = c("P√∫blico", "Privado"),
                        values = c("solid", "dashed")) +
  scale_y_continuous(limits = c(0,0.40), breaks=seq(0,0.40, by = 0.05),
                     labels = scales::percent_format(accuracy = 1L)) +
  theme_bw() +
  labs(title="", y = "") + 
  theme(plot.title = element_text(size = 11),
        axis.text=element_text(size=11))

FigSindSector_int
```

* Sector de empleo - politizaci√≥n

```{r}
m3.2log <- glm(demonstr_dummy~ Unionized + Female + X003 + Educ + private_sector 
               + politicization + Wave + private_sector*politicization,
               data = WVS_2005_2022_Chl,family = "binomial")
```


```{r results='asis'}
htmlreg(list(m1log,m2log,m3log,m3.1log,m3.2log),
          custom.model.names = c("M1 (log odds)","M2 (log odds)","M3 (log odds)",
                                 "M3.1 (log odds)","M3.2 (log odds)"),
          digits = 3, 
          stars = c(0.001, 0.01, 0.05, 0.1),symbol = "‚Ä†")
```


```{r}
FigPolitSector_int<-ggeffects::ggpredict(m3.2log, terms = c("politicization", "private_sector")) %>%
  ggplot(aes(x=x, y=predicted, shape = group, color = group)) +
  geom_line(aes(group=group,linetype = group),position = position_dodge(.1)) + 
  geom_point(size = 2.5,position = position_dodge(.1))+
  scale_x_continuous(breaks=seq(0,6, by = 1), name = "") + 
  scale_shape_discrete(name = "Sector de empleo",
                       limits = c("0", "1"),
                       labels = c("P√∫blico", "Privado")) +
  scale_color_manual(name = "Sector de empleo",
                     limits = c("0", "1"),
                     labels = c("P√∫blico", "Privado"),
                     values = c("black", "black")) +
  scale_linetype_manual(name = "Sector de empleo",
                        limits = c("0", "1"),
                        labels = c("P√∫blico", "Privado"),
                        values = c("solid", "dashed")) +
  scale_y_continuous(limits = c(0,0.8), breaks=seq(0,0.8, by = 0.1),
                     labels = scales::percent_format(accuracy = 1L)) +
  theme_bw() +
  labs(title="", y = "") + 
  theme(plot.title = element_text(size = 11),
        axis.text=element_text(size=11))
FigPolitSector_int
```





